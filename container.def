# This file is auto-generated by bin/generate-container-def
# DO NOT EDIT

Bootstrap: docker
From: ubuntu:24.04
Stage: spython-base

%files
.mise.toml /opt/.mise.toml
.ruby-version /opt/.ruby-version
requirements.txt /opt/requirements.txt
package.json /opt/node/
package-lock.json /opt/node/
Gemfile /opt/Gemfile
Gemfile.lock /opt/Gemfile.lock
tools/ruby-gems/idlc/idlc.gemspec /opt/tools/ruby-gems/idlc/
tools/ruby-gems/idlc/lib/gem_versions.rb /opt/tools/ruby-gems/idlc/lib/
tools/ruby-gems/idlc/lib/idlc/version.rb /opt/tools/ruby-gems/idlc/lib/idlc/
tools/ruby-gems/idl_highlighter/idl_highlighter.gemspec /opt/tools/ruby-gems/idl_highlighter/
tools/ruby-gems/idl_highlighter/lib/idl_highlighter/version.rb /opt/tools/ruby-gems/idl_highlighter/lib/idl_highlighter/
tools/ruby-gems/udb/udb.gemspec /opt/tools/ruby-gems/udb/
tools/ruby-gems/udb/lib/gem_versions.rb /opt/tools/ruby-gems/udb/lib/
tools/ruby-gems/udb/lib/udb/version.rb /opt/tools/ruby-gems/udb/lib/udb/
tools/ruby-gems/udb-gen/udb-gen.gemspec /opt/tools/ruby-gems/udb-gen/
tools/ruby-gems/udb-gen/lib/gem_versions.rb /opt/tools/ruby-gems/udb-gen/lib/
tools/ruby-gems/udb-gen/lib/udb-gen/version.rb /opt/tools/ruby-gems/udb-gen/lib/udb-gen/
tools/ruby-gems/udb_helpers/udb_helpers.gemspec /opt/tools/ruby-gems/udb_helpers/
tools/ruby-gems/udb_helpers/lib/udb_helpers/version.rb /opt/tools/ruby-gems/udb_helpers/lib/udb_helpers/
tools/ruby-gems/idlc/bin/idlc /workspace/bin/container
tools/ruby-gems/udb/bin/udb /workspace/bin/container
tools/ruby-gems/udb-gen/bin/udb-gen /workspace/bin/container
%labels
org.opencontainers.image.source=https://github.com/riscv/riscv-unified-db
%post -c /bin/bash

DEBIAN_FRONTEND=noninteractive

mkdir -p /workspace
cd /workspace

# please keep pkgs sorted
apt-get update && \
apt-get install -y --no-install-recommends --fix-missing \
build-essential \
clang-format \
clang-tidy \
cmake \
curl \
ditaa \
g++ \
gcc-riscv64-linux-gnu \
gcc-riscv64-unknown-elf \
gdb \
gh \
git \
gpg \
gpg-agent \
less \
libc6-dev-riscv64-cross \
libelf-dev \
libgmp-dev \
libnewlib-dev \
libyaml-dev \
libz3-dev \
minisat \
parallel \
rustc \
shellcheck \
sudo \
zlib1g-dev \
\
&& apt-get clean autoclean \
&& apt-get autoremove -y \
&& rm -rf /var/lib/{apt,dpkg,cache,log}/*

MISE_DATA_DIR="/mise"
MISE_CONFIG_DIR="/mise"
MISE_CACHE_DIR="/mise/cache"
# MISE_STATE_DIR needed to prevent permission errors in CI when mise tries to track configs
# Without this, mise defaults to ~/.local/state which isn't writable by non-root CI users
MISE_STATE_DIR="/mise/state"
MISE_INSTALL_PATH="/usr/local/bin/mise"
MISE_YES=1

curl https://mise.run | sh


mkdir -p /opt
cd /opt
mise trust /opt/.mise.toml && \
mise settings set trusted_config_paths '~' && \
mise install --yes

chmod -R 777 /mise

# Verify tools work after mise installation
cd /opt && \
mise env --shell bash | grep '^export PATH=' > /etc/profile.d/mise-path-temp.sh && \
bash -c 'source /etc/profile.d/mise-path-temp.sh && ruby --version && node --version && npm --version && python3 --version'

# build/install eqntott
git clone --depth=1 https://github.com/TheProjecter/eqntott.git && \
cd eqntott && \
./configure && \
make && make install && \
cd .. && \
rm -rf eqntott

# build/install espresso
git clone --depth=1 https://github.com/psksvp/espresso-ab-1.0.git && \
cd espresso-ab-1.0 && \
./configure && \
make && make install && \
cd .. && \
rm -rf espresso-ab-1.0

# build / install must
# mcsmus/mcsmus/control.cc is missing #include <cstdio>, thus the sed below
git clone https://github.com/jar-ben/mustool.git && \
cd mustool && \
git checkout 17fa9f9542a9ce05328dfccd1cd410f05f741ab3 && \
sed -i -e 's/#include <signal.h>/#include <signal.h>\n#include <cstdio>/' mcsmus/mcsmus/control.cc && \
make -j && \
install must -m 0777 /usr/bin/must && \
cd .. && \
rm -rf mustool

# Create Python virtual environment and install packages
bash -l -c 'python3 -m venv /opt/venv && \
/opt/venv/bin/pip install --no-cache-dir -r /opt/requirements.txt && \
rm /opt/requirements.txt'
PATH="/opt/venv/bin:$PATH"

# Install npm packages globally in the container
bash -l -c 'cd /opt/node && \
npm ci --no-audit --no-fund && \
chown -R root:root /opt/node/node_modules && \
rm /opt/node/package.json /opt/node/package-lock.json'
NODE_PATH="/opt/node/node_modules"
PATH="/opt/node/node_modules/.bin:$PATH"
IN_UDB_CONTAINER=true

# install gems
bash -l -c 'bundle install --gemfile /opt/Gemfile'

# Remove mise binary and unset MISE_* env vars to prevent workspace .mise.toml detection
# Replace mise wrapper scripts (npm/npx) with direct symlinks to avoid "mise: command not found"
# Tools remain accessible via the PATH extracted earlier to /etc/profile.d/mise-path.sh
rm -f /usr/local/bin/mise && \
rm -rf /mise/cache /mise/downloads && \
echo 'unset MISE_DATA_DIR MISE_CONFIG_DIR MISE_CACHE_DIR MISE_STATE_DIR MISE_INSTALL_PATH MISE_YES' >> /etc/bash.bashrc && \
for node_dir in /mise/installs/node/*/bin; do \
rm -f "$node_dir/npm" "$node_dir/npx" && \
ln -s ../lib/node_modules/npm/bin/npm-cli.js "$node_dir/npm" && \
ln -s ../lib/node_modules/npm/bin/npx-cli.js "$node_dir/npx"; \
done

# the binaries for gems need to be copied in
mkdir -p /workspace/bin/container
PATH="/workspace/bin/container:$PATH"

# Grant the default ubuntu user sudo access
echo ubuntu ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/ubuntu \
&& chmod 0440 /etc/sudoers.d/ubuntu

# Set complete PATH as ENV for Singularity compatibility (doesn't support ENTRYPOINT)
# We use mise's 'latest' symlinks for Node and Ruby to avoid hardcoding versions
# Python uses /opt/venv (with packages) instead of mise Python (without packages)
PATH="/workspace/bin/container:/opt/node/node_modules/.bin:/opt/venv/bin:/opt/bin:/mise/installs/node/latest/bin:/mise/installs/ruby/latest/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Create mise-path.sh with the final PATH for Docker ENTRYPOINT (matches ENV above)
echo "export PATH='/workspace/bin/container:/opt/node/node_modules/.bin:/opt/venv/bin:/opt/bin:/mise/installs/node/latest/bin:/mise/installs/ruby/latest/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'" > /etc/profile.d/mise-path.sh && \
chmod +x /etc/profile.d/mise-path.sh

# Create a wrapper script that sources profile and executes commands
echo '#!/bin/bash' > /entrypoint.sh && \
echo 'source /etc/profile.d/mise-path.sh' >> /entrypoint.sh && \
echo 'exec "$@"' >> /entrypoint.sh && \
chmod +x /entrypoint.sh

# Set ENTRYPOINT to the wrapper script
%environment
export DEBIAN_FRONTEND=noninteractive
export MISE_DATA_DIR="/mise"
export MISE_CONFIG_DIR="/mise"
export MISE_CACHE_DIR="/mise/cache"
export MISE_STATE_DIR="/mise/state"
export MISE_INSTALL_PATH="/usr/local/bin/mise"
export MISE_YES=1
export PATH="/opt/venv/bin:$PATH"
export NODE_PATH="/opt/node/node_modules"
export PATH="/opt/node/node_modules/.bin:$PATH"
export IN_UDB_CONTAINER=true
export PATH="/workspace/bin/container:$PATH"
export PATH="/workspace/bin/container:/opt/node/node_modules/.bin:/opt/venv/bin:/opt/bin:/mise/installs/node/latest/bin:/mise/installs/ruby/latest/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
